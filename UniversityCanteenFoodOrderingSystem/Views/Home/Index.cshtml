@using Microsoft.AspNetCore.Identity
@using UniversityCanteenFoodOrderingSystem.Areas.Identity.Data
@inject SignInManager<AppUser> SignInManager
@inject UserManager<AppUser> UserManager
@using UniversityCanteenFoodOrderingSystem.Models



@{
    ViewData["Title"] = "Home Page";
}
@model IEnumerable<MenuItem> 


@{
    var currentUser = await UserManager.GetUserAsync(User);
    var categories = Model.Select(item => item.Category).Distinct().ToList();
}   

    
    @* Condition check if the user session is active *@

    @if(SignInManager.IsSignedIn(User) && currentUser != null)
	{
        <!-- Dashboard Hero / Stats Section -->
        <section class="py-5 text-center bg-light mb-4">
            <div class="container">
                <h2 class="fw-bold">🍔 Fresh, Fast & Fun!</h2>
                <p class="text-muted">Order your favorite meals in seconds and enjoy hassle‑free dining at UniBite.</p>
                <div class="row mt-4">
                    <div class="col-md-4">
                        <h3 class="fw-bold text-primary">100+</h3>
                        <p class="text-muted">Daily Orders</p>
                    </div>
                    <div class="col-md-4">
                        <h3 class="fw-bold text-success">25+</h3>
                        <p class="text-muted">Menu Items</p>
                    </div>
                    <div class="col-md-4">
                        <h3 class="fw-bold text-warning">200+</h3>
                        <p class="text-muted">Happy Students</p>
                    </div>
                </div>
            </div>
        </section>

    

        <div class="text-center my-4">

        <h2 class="fw-bold">Our Menu</h2>
        <!-- Search Box -->
        <input type="text" id="searchBox" class="form-control w-50 mx-auto mb-4" placeholder="Search food..." />
        <!-- Category Filter Buttons -->
            <div id="category-buttons" class="btn-group container">
                <button class="btn btn-outline-primary active" data-filter="all">All</button>
                @foreach (var category in categories)
                {
                    <button class="btn btn-outline-primary" data-filter="@category">@category</button>
                }
            </div>
        </div>
        

		<div class="alert alert-success text-center" role="alert">
        Welcome back, <strong>Mr. @currentUser.FullName</strong>! Ready to satisfy your hunger with UniBite? 🍽️
		</div>
        <div class="alert alert-warning alert-dismissible fade show text-center" role="alert">
        <strong>you may also order food manually from the UniBite Canteen.</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <div class="row">
            @foreach (var item in Model)
            {

                <div class="col-md-3 mb-4 menu-item shadow-lg "  data-category="@item.Category" data-name="@item.Name">
                    <div class="card shadow-sm h-100 border-0">
                            
                        <!-- Card Image -->
                    <img src="@item.ImageUrl" class="card-img-top" alt="@item.Name" style="object-fit:cover;" />

                        <!-- Card Body -->
                        <div class="card-body text-center">
                            <h5 class="card-title">@item.Name</h5>
                            <p class="text-muted">Category: <strong>@item.Category</strong></p>
                            <p class="fs-5 fw-bold">Rs. @item.Price</p>
                            <span class="badge @(item.Availability ? "bg-success" : "bg-danger")">
                                @(item.Availability ? "Available" : "Not Available")
                            </span>
                        </div>


                    <div class="input-group mb-3 w-auto">
                        <button class="btn btn-outline-danger px-3" type="button" onclick="decrementQty(@item.ItemId)">-</button>
                        <input type="text" id="qty-@item.ItemId" class="form-control text-center fw-bold" value="1" readonly />
                        <button class="btn btn-outline-success px-3" type="button" onclick="incrementQty(@item.ItemId)">+</button>
                    </div>


                        <!-- Card Footer with Actions -->
                    <div class="card-footer d-flex justify-content-between">
                        <form asp-action="AddToCart" method="post">
                            <input type="hidden" name="ItemId" value="@item.ItemId" />
                            <input type="hidden" id="cart-qty-hidden-@item.ItemId" name="Quantity" value="1" />
                            <button type="submit" class="btn btn-warning"
                                    onclick="document.getElementById('cart-qty-hidden-@item.ItemId').value = document.getElementById('qty-@item.ItemId').value;">
                                Add to Cart
                            </button>
                        </form>



                        <!-- Order Now button -->
                        <button type="button" class="btn btn-success"
                                data-bs-toggle="modal" data-bs-target="#orderModal-@item.ItemId"
                                onclick="syncModalQty(@item.ItemId)">
                            Order Now
                        </button>





                    </div>

                    <!-- Feedback -->
                    <div class="card-footer text-end">
                        <a href="#" class="small text-muted" data-bs-toggle="modal" data-bs-target="#feedbackModal-@item.ItemId">
                            <i class="bi bi-chat-dots"></i> Feedback
                        </a>
                    </div>



                    </div>
                </div>

            <!-- No Results Message --> 
            <div id="noResults" class="text-center text-danger fw-bold mt-3" style="display:none;">
                No item or category found! 
                </div>
                <!--Order Now Confirmation Modal-->
            <div class="modal fade" id="orderModal-@item.ItemId" tabindex="-1" aria-labelledby="orderModalLabel-@item.ItemId" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">

                        <div class="modal-header">
                            <h5 class="modal-title" id="orderModalLabel-@item.ItemId">Confirm Order</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>

                        <div class="modal-body">
                            <p>You are ordering <strong><span id="qty-display-@item.ItemId">1</span> × @item.Name</strong></p>

                            @if (ViewBag.HasActiveOrder == false)
                            {
                                <label for="paymentMethod-@item.ItemId" class="form-label">Payment Method:</label>
                                <select id="paymentMethod-@item.ItemId" class="form-select">
                                    <option value="CashOnPickup">Cash On Pickup</option>
                                    <option value="OnlineTransferOnPickup">Online Transfer On Pickup</option>
                                </select>
                            }
                            else
                            {
                                <p class="text-muted">Payment method already selected for this order.</p>
                            }
                        </div>

                        <div class="modal-footer">
                            <form asp-action="DirectOrder" method="post" onsubmit="return prepareOrder(@item.ItemId)">
                                <input type="hidden" name="ItemId" value="@item.ItemId" />
                                <input type="hidden" id="order-qty-hidden-@item.ItemId" name="Quantity" value="1" />
                                <input type="hidden" name="PaymentMethod" id="selectedPayment-@item.ItemId" />

                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary">Yes, Order It</button>
                            </form>
                        </div>

                    </div>
                </div>
            </div>





            <!-- Feedback Modal -->
            <div class="modal fade" id="feedbackModal-@item.ItemId" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">

                        <div class="modal-header">
                            <h5 class="modal-title">Feedback for @item.Name</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>

                        <div class="modal-body">
                            <form asp-controller="Home" asp-action="SubmitFeedback" method="post">
                                <input type="hidden" name="ItemId" value="@item.ItemId" />
                                <input type="hidden" name="UserId" value="@currentUser.Id" />

                                <div class="mb-3">
                                    <label class="form-label">Rating</label>
                                    <select name="Rating" class="form-select">
                                        <option value="5">⭐⭐⭐⭐⭐ Excellent</option>
                                        <option value="4">⭐⭐⭐⭐ Good</option>
                                        <option value="3">⭐⭐⭐ Average</option>
                                        <option value="2">⭐⭐ Poor</option>
                                        <option value="1">⭐ Very Bad</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Comment</label>
                                    <textarea name="Comment" class="form-control" rows="3"></textarea>
                                </div>

                                <button type="submit" class="btn btn-warning w-100">Submit Feedback</button>
                            </form>


                        </div>
                    </div>
                </div>
            </div>


            }
        </div>

	}
	else
	{
		    @* <div class="alert alert-info text-center" role="alert">
			    Welcome to UniBite! Please <a asp-area="Identity" asp-page="/Account/Login">Login</a> or <a asp-area="Identity" asp-page="/Account/Register">Register</a> to start ordering delicious meals! 🍔🍕
		    </div> *@

            <!-- Hero Section -->
            <section class="bg-primary text-white text-center py-5" style="background:url('/images/hero-food.jpg') center/cover no-repeat;">
                <div class="container">
                    <h1 class="display-4 fw-bold">Welcome to UniBite 🍽️</h1>
                    <p class="lead mb-4">Your University Canteen Food Ordering System</p>

                    <!-- CTA Buttons -->
                    <div class="d-flex justify-content-center gap-3">
                        <a asp-area="Identity" asp-page="/Account/Login" class="btn btn-warning btn-lg">
                            <i class="bi bi-box-arrow-in-right"></i> Login to Order
                        </a>
                        <a asp-area="Identity" asp-page="/Account/Register" class="btn btn-success btn-lg">
                            <i class="bi bi-person-plus"></i> Register Now
                        </a>
                    </div>

                    <a href="#about" class="btn btn-light btn-sm mt-4">
                        <i class="bi bi-info-circle"></i> Learn More
                    </a>
                </div>
            </section>

    <!-- About Section -->
    <section id="about" class="py-5 bg-light">
        <div class="container">
            <!-- Heading -->
            <div class="text-center mb-5">
                <h2 class="fw-bold text-dark">About UniBite</h2>
                <p class="text-muted lead">
                    UniBite is your university canteen’s digital food ordering system — designed to make ordering meals
                    faster, smarter, and more engaging. Our mission is to save students time, reduce queues, and provide
                    a modern way to enjoy hygienic and affordable food.
                </p>
            </div>

            <!-- Features Row -->
            <div class="row text-center mb-5">
                <div class="col-md-4">
                    <i class="bi bi-search display-4 text-warning"></i>
                    <h5 class="mt-3 fw-bold">Instant Search</h5>
                    <p class="text-muted">Quickly find meals using our client-side search and interactive category filters.</p>
                </div>
                <div class="col-md-4">
                    <i class="bi bi-ui-checks-grid display-4 text-success"></i>
                    <h5 class="mt-3 fw-bold">Smart Dashboard</h5>
                    <p class="text-muted">Unified dashboard keeps ordering, feedback, and receipts simple and student-friendly.</p>
                </div>
                <div class="col-md-4">
                    <i class="bi bi-chat-dots-fill display-4 text-danger"></i>
                    <h5 class="mt-3 fw-bold">Feedback System</h5>
                    <p class="text-muted">Give item-specific feedback via modern modals with SweetAlert confirmation popups.</p>
                </div>
            </div>

            <!-- Food Gallery -->
            <div class="row text-center mb-5">
                <div class="col-md-4 mb-3">
                    <img src="/images/biryani.jpg" class="img-fluid rounded shadow-lg" alt="Biryani" />
                    <h6 class="mt-2 fw-bold">Chicken Biryani</h6>
                </div>
                <div class="col-md-4 mb-3">
                    <img src="/images/zinger.jpg" class="img-fluid rounded shadow-lg" alt="Zinger Burger" />
                    <h6 class="mt-2 fw-bold">Zinger Burger</h6>
                </div>
                <div class="col-md-4 mb-3">
                    <img src="/images/tea.jpg" class="img-fluid rounded shadow-lg" alt="Tea" />
                    <h6 class="mt-2 fw-bold">Special Tea</h6>
                </div>
            </div>

            <!-- Stats Section -->
            <div class="row text-center mt-5">
                <div class="col-md-4">
                    <h3 class="fw-bold text-primary">500+</h3>
                    <p class="text-muted">Orders Served</p>
                </div>
                <div class="col-md-4">
                    <h3 class="fw-bold text-success">200+</h3>
                    <p class="text-muted">Happy Students</p>
                </div>
                <div class="col-md-4">
                    <h3 class="fw-bold text-danger">Working Hours</h3>
                    <p class="text-muted">Mon – Sat: 9:00 AM – 10:00 PM</p>
                    <p class="text-muted">Sunday: Closed</p>
                </div>

            </div>
        </div>
    </section>




        <section class="py-5 bg-light">
            <div class="container text-center">
                <h2 class="fw-bold mb-4">Why Choose UniBite?</h2>
                <div class="row">
                    <div class="col-md-4">
                        <i class="bi bi-speedometer2 display-4 text-primary"></i>
                        <h5 class="mt-3">Fast Ordering</h5>
                        <p class="text-muted">Place your order in seconds with our instant search and filters.</p>
                    </div>
                    <div class="col-md-4">
                        <i class="bi bi-shield-check display-4 text-success"></i>
                        <h5 class="mt-3">Secure & Reliable</h5>
                        <p class="text-muted">Your data and payments are safe with UniBite.</p>
                    </div>
                    <div class="col-md-4">
                        <i class="bi bi-heart-fill display-4 text-danger"></i>
                        <h5 class="mt-3">Delicious Variety</h5>
                        <p class="text-muted">From biryani to burgers, enjoy hygienic meals at affordable prices.</p>
                    </div>
                </div>
            </div>
        </section>

	}

    
@section Scripts {
    
    @*Alert on Item*@
    @if (TempData["Message"] != null)
    {
        <script>
            Swal.fire({
                toast: true,
                position: "top-end",
                icon: "success",
                title: "@TempData["Message"]",
                showConfirmButton: false,
                timer:3000,
            });
        </script>
    }
    else if (TempData["Error"] != null)
    {
        <script>
            Swal.fire({
                position: "top-end",
                icon: "error",
                title: "@TempData["Error"]",
                showConfirmButton: true
            });
        </script>
    }


    @*Confirm Order Alert*@
    
        <script>
            function confirmDirectOrder(e) {
                e.preventDefault();
                Swal.fire({
                    title: 'Confirm Direct Order?',
                    text: "Do you want to order this item?",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, order it!',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        e.target.submit();
                    }
                });
                return false;
            }
        </script>
              
        
        <script>
        function incrementQty(itemId) {
            let input = document.getElementById("qty-" + itemId);
            input.value = parseInt(input.value) + 1;
        }

        function decrementQty(itemId) {
            let input = document.getElementById("qty-" + itemId);
            let val = parseInt(input.value);
            if (val > 1) input.value = val - 1;
        }

        function syncModalQty(itemId) {
            let qty = document.getElementById("qty-" + itemId).value;
            document.getElementById("qty-display-" + itemId).innerText = qty;
            document.getElementById("order-qty-hidden-" + itemId).value = qty; // ✅ modal hidden field update
        }

        function prepareOrder(itemId) {
            let qty = document.getElementById("qty-" + itemId).value;
            let pay = document.getElementById("paymentMethod-" + itemId).value;

            document.getElementById("order-qty-hidden-" + itemId).value = qty;
            document.getElementById("selectedPayment-" + itemId).value = pay;

            return true;
        }


        </script>

}






